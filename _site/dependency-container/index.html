<!DOCTYPE html>
<!--
Hyperspace by HTML5 UP
html5up.net | @ajlkn
Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
<head>
    <title>Dependency Container - Fano Framework</title>
    <meta charset="utf-8" />
    <meta name="description" content="Tutorial on how to work with dependency container in Fano Framework">
    <meta name="keywords" content="fano, web application, framework, pascal, programming, language, free pascal">
    <meta name="robots" content="index, follow"/>
    <meta property="og:title" content="Dependency Container"/>
    <meta property="og:site_name" content="Fano Framework"/>
    <meta property="og:url" content="http://localhost:4000/dependency-container/"/>
    <meta property="og:description" content="Tutorial on how to work with dependency container in Fano Framework"/>
    <meta property="og:type" content="website"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="shortcut icon" href="/assets/images/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="/assets/css/main.css" />
    <noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript>
</head>
<body class="is-preload">


<!-- Sidebar -->
<section id="sidebar">
    <div class="inner">
        <nav>
            <ul>
                
                    <h3>Getting Started</h3>
                      <ul class="alt">
                        
                          <li><a href="/getting-started">Getting Started</a></li>
                        
                          <li><a href="/tutorials">Step By Step Tutorials</a></li>
                        
                      </ul>
                
                    <h3>Basic</h3>
                      <ul class="alt">
                        
                          <li><a href="/getting-started">Getting Started</a></li>
                        
                      </ul>
                
            </ul>
        </nav>
    </div>
</section>


<!-- Wrapper -->
<div id="wrapper">
    <!-- Main -->
    <section id="main" class="wrapper">
        <div class="inner">
            <h1 class="major">Dependency Container</h1>

<h2 id="why-dependency-container">Why dependency container?</h2>

<p>Fano Framework is designed to be extensible. It uses class composition heavily.
Instead of creating class with deep inheritance, many complex classes in this framework depend on one or more classes that do simple thing.</p>

<p>Because of this, creating instance of a class may require us to create
other classes instance that it requires. Some classes may shared same dependency to same class, some classes may not. Some classes need same instance of
other class instance, while some other may requires new instance.</p>

<p>This task grows in complexity when scope of problem grows. So we need to provide a way to manage dependencies between software components in application.</p>

<h2 id="container-factory-and-its-service">Container, factory and its service</h2>

<p>Dependency container, or simply container, is software component that manages
any software components (a.k.a, service). In Fano Framework, dependency container
implementation must implements <code class="highlighter-rouge">IDependencyContainer</code> interface.</p>

<p>The services are registered into dependency container during service registration which later can be queried to retrieve service instance.</p>

<p>During service registration, a service name is associated with a factory class
that must implements <code class="highlighter-rouge">IDependencyFactory</code> interface that will responsible to create the required service.</p>

<p>For a service to be able to work with <code class="highlighter-rouge">IDependencyContainer</code> implementation, it must implements <code class="highlighter-rouge">IDependency</code> interface. Fano Framework comes with base class <code class="highlighter-rouge">TInjectableObject</code> that implements <code class="highlighter-rouge">IDependency</code> interface.</p>

<h2 id="service-registration">Service registration</h2>

<p>To register a service, dependency container provides two method <code class="highlighter-rouge">add()</code> and <code class="highlighter-rouge">factory()</code>. See “Single vs multiple instance”  section for explanation.</p>

<p>For example, following code registers service factory <code class="highlighter-rouge">TSimpleRouterFactory</code> with name <code class="highlighter-rouge">router</code>. This factory class will create <code class="highlighter-rouge">TRouter</code> class.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>container.add('router', TSimpleRouterFactory.create());
</code></pre></div></div>

<p>You can also use alternative way</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>container.add(GUIDToString(IRouteMatcher), TSimpleRouterFactory.create());
</code></pre></div></div>

<h2 id="retrieve-service-instance-from-dependency-container">Retrieve service instance from dependency container</h2>

<p>Later, to get instance of <code class="highlighter-rouge">router</code> from container,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var inst : IDependency;
...
inst := container.get('router');
</code></pre></div></div>

<p>In Fano Framework, <code class="highlighter-rouge">get()</code> method of <code class="highlighter-rouge">IDependencyContainer</code> always returns <code class="highlighter-rouge">IDependency</code> interface instance. So you need to convert it to its correct type
before you can use it.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var router : IRouteMatcher;
...
router := inst as IRouteMatcher;
</code></pre></div></div>
<p>or simply,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var router : IRouteMatcher;
...
router := container.get('router') as IRouteMatcher;
</code></pre></div></div>

<p>or if use GUID string as service name</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var router : IRouteMatcher;
...
router := container.get(GUIDToString(IRouteMatcher)) as IRouteMatcher;
</code></pre></div></div>

<p>When <code class="highlighter-rouge">get()</code> can not find service, it raises <code class="highlighter-rouge">EDependencyNotFound</code> exception.
If service is registered but with nil factory class, <code class="highlighter-rouge">EInvalidFactory</code> exception is raised.</p>

<h2 id="test-if-service-is-registered">Test if service is registered</h2>

<p>Dependency container provides <code class="highlighter-rouge">has()</code> method which return boolean value that can be used to check if particular service is registered or not.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (container.has('router')) then
begin
   //router is registered, do something
end;
</code></pre></div></div>

<h2 id="single-vs-multiple-instance">Single vs multiple instance</h2>

<p>When a service is registered using <code class="highlighter-rouge">add()</code> method, it is registered as single instance service. So every time a service is queried, container returns
same instance.</p>

<p>In following example <code class="highlighter-rouge">router1</code> and <code class="highlighter-rouge">router2</code> will point to same instance.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>container.add('router', TSimpleRouteCollectionFactory.create());
...
var router1, router2 : IRouteMatcher;
...
router1 := container.get('router') as IRouteMatcher;
router2 := container.get('router') as IRouteMatcher;
</code></pre></div></div>

<p>When a service is registered using <code class="highlighter-rouge">factory()</code> method, it is registered as multiple instance services. So every time a service is queried, container returns
different instance. In code below, <code class="highlighter-rouge">router1</code> and <code class="highlighter-rouge">router2</code> will point to different instance.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>container.factory('router', TSimpleRouteCollectionFactory.create());
...
var router1, router2 : IRouteMatcher;
...
router1 := container.get('router') as IRouteMatcher;
router2 := container.get('router') as IRouteMatcher;
</code></pre></div></div>

<h2 id="adding-service-alias">Adding service alias</h2>

<p>To register new name for an existing service, dependency container provides method <code class="highlighter-rouge">alias()</code>.
This method expects two parameters. First parameter is new name for existing service, and second parameter identifies existing service to be aliased.</p>

<p>For example, if you have service registered as follows,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>container.add(GUIDToString(IRouteMatcher), TSimpleRouterFactory.create());
</code></pre></div></div>

<p>You can create alias for above service as follows,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>container.alias(GUIDToString(IRouter), GUIDToString(IRouteMatcher));
</code></pre></div></div>

<p>Then you can retrieve instance using</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var
   router : IRouter;
   routeMatcher : IRouteMatcher;
...
router := container.get(GUIDToString(IRouter)) as IRouter;
routeMatcher := container.get(GUIDToString(IRouteMatcher)) as IRouteMatcher;
</code></pre></div></div>

<p>Both <code class="highlighter-rouge">router</code> and <code class="highlighter-rouge">routeMatcher</code> will point to same class instance.</p>

<p>However, if you have service registered as multipe instances,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>container.factory(GUIDToString(IRouteMatcher), TSimpleRouterFactory.create());
</code></pre></div></div>

<p><code class="highlighter-rouge">router</code> and <code class="highlighter-rouge">routeMatcher</code> will point to different instance.</p>

<h2 id="built-in-dependency-container">Built-in dependency container</h2>

<p>Fano Framework comes with several built-in dependency containers,</p>

<ul>
  <li><code class="highlighter-rouge">TDependencyContainer</code>, this is basic dependency container.</li>
  <li><code class="highlighter-rouge">TInitializeableContainer</code>, this is abstract dependency container. Descendant class must implements <code class="highlighter-rouge">initializeServices()</code> method.</li>
</ul>

<p><code class="highlighter-rouge">TInitializeableContainer</code> is provided to allows developer to initialize service registration in a dedicated dependency container instance instead of in application <code class="highlighter-rouge">buildDependencies()</code> method.</p>

<p>So instead of</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TBootstrapApp = class(TFanoWebApplication)
protected
   procedure buildDependencies(const container : IDependencyContainer); override;
   ...
end;
...
procedure TBootstrapApp.buildDependencies(const container : IDependencyContainer);
begin
   {$INCLUDE Dependencies/dependencies.inc}
end;
</code></pre></div></div>

<p>you create dedicated service container class</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TServiceContainer = class(TInitializeableContainer)
protected
   procedure initializeServices(const container : IDependencyContainer); override;
end;
...
procedure TServiceContainer.initializeServices(const container : IDependencyContainer);
begin
   {$INCLUDE Dependencies/dependencies.inc}
end;
</code></pre></div></div>

<p>and in application</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>appInstance := TBootstrapApp.create(
   TServiceContainer.create(
      TDependencyContainer.create(TDependencyList.create())
   )
);
</code></pre></div></div>

<p>Of course, you are free to implements your own dependency container, as long as it implements <code class="highlighter-rouge">IDependencyContainer</code> interface.</p>

<h2 id="auto-wire-dependency">Auto-wire dependency</h2>

<p>Auto-wire dependency is not yet implemented.</p>

<h2 id="explore-more">Explore more</h2>

<ul>
  <li><a href="/working-with-application">Working with Application</a></li>
</ul>

<ul class="actions">
    <li><a href="/documentation" class="button">Documentation</a></li>
</ul>

        </div>
    </section>
</div>


    <!-- Scripts -->
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/jquery.scrollex.min.js"></script>
    <script src="/assets/js/jquery.scrolly.min.js"></script>
    <script src="/assets/js/browser.min.js"></script>
    <script src="/assets/js/breakpoints.min.js"></script>
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/main.js"></script>

</body>
</html>

