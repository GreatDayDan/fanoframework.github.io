<!DOCTYPE html>
<!--
Hyperspace by HTML5 UP
html5up.net | @ajlkn
Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
<head>
    <title>Deploy as FastCGI application - Fano Framework</title>
    <meta charset="utf-8" />
    <meta name="description" content="Tutorial on how to deploy FastCGI web application built with Fano Framework to various web servers.">
    <meta name="keywords" content="fano, web application, framework, pascal, programming, language, free pascal">
    <meta name="robots" content="index, follow"/>
    <meta property="og:title" content="Deploy as FastCGI application"/>
    <meta property="og:site_name" content="Fano Framework"/>
    <meta property="og:url" content="http://localhost:4000/deployment/fastcgi/"/>
    <meta property="og:description" content="Tutorial on how to deploy FastCGI web application built with Fano Framework to various web servers."/>
    <meta property="og:type" content="website"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="shortcut icon" href="/assets/images/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="/assets/css/main.css" />
    <noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript>
</head>
<body class="is-preload">


<!-- Sidebar -->
<section id="sidebar">
    <div class="inner">
        <nav>
            <ul>
                
                    <h3>Getting Started</h3>
                      <ul class="alt">
                        
                          <li><a href="/getting-started">Getting Started</a></li>
                        
                          <li><a href="/tutorials">Step By Step Tutorials</a></li>
                        
                      </ul>
                
                    <h3>Basic</h3>
                      <ul class="alt">
                        
                          <li><a href="/getting-started">Getting Started</a></li>
                        
                      </ul>
                
            </ul>
        </nav>
    </div>
</section>


<!-- Wrapper -->
<div id="wrapper">
    <!-- Main -->
    <section id="main" class="wrapper">
        <div class="inner">
            <h1 class="major">Deployment as FastCGI application</h1>

<p>Fano Framework can be deployed as <a href="https://fastcgi-archives.github.io/FastCGI_Specification.html">FastCGI</a> web application.</p>

<p>See <a href="/working-with-application">Working with Application</a> for information how to create FastCGI web application.</p>

<p>See example application:</p>

<ul>
  <li><a href="https://github.com/fanoframework/fano-fastcgi">Fano FastCGI</a>, example FastCGI application which listening on TCP host:port</li>
  <li><a href="https://github.com/fanoframework/fano-fcgi-unix">Fano FCGI Unix</a>, example FastCGI application which listening using Unix Domain Socket.</li>
  <li><a href="https://github.com/fanoframework/fano-fcgid">Fano fcgid</a>, example FastCGI application which started automatically by <a href="https://httpd.apache.org/mod_fcgid/mod/mod_fcgid.html">Apache mod_fcgid</a> module.</li>
</ul>

<p>You may want to look <a href="/scaffolding-with-fano-cli">Scaffolding with Fano CLI</a> to easily
create new FastCGI web application project.</p>

<h2 id="deploy-with-fano-cli">Deploy with Fano CLI</h2>

<p>Simplest way to setup Fano web application with web server is to deploy FastCGI application with <a href="https://github.com/fanoframework/fano-cli">Fano CLI</a>, run with <code class="highlighter-rouge">--deploy-fcgi=[domain name]</code> or <code class="highlighter-rouge">--deploy-fcgid=[domain name]</code>. The first command will setup FastCGI virtual host that works with <code class="highlighter-rouge">mod_proxy_fcgi</code> while the other for <code class="highlighter-rouge">mod_fcgid</code>.</p>

<p>Inside Fano web application project directory, run</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo fanocli --deploy-fcgi=myapp.me
</code></pre></div></div>

<p>Command above, will create virtual host for Apache web server, enabled virtual host configuration, reload Apache web server configuration and add entry to <code class="highlighter-rouge">myapp.me</code> domain in <code class="highlighter-rouge">/etc/hosts</code>.</p>

<p>To setup for nginx web server add <code class="highlighter-rouge">--web-server=nginx</code>. Without it, it is assumed Apache web server.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo fanocli --deploy-fcgi=myapp.me --web-server=nginx
</code></pre></div></div>

<p>To deploy FastCGI web application for Apache mod_fcgid, run with <code class="highlighter-rouge">--deploy-fcgid</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo fanocli --deploy-fcgid=myapp.me
</code></pre></div></div>

<h2 id="apache-with-mod_proxy_fcgi-module">Apache with mod_proxy_fcgi module</h2>

<p>To deploy as FastCGI application with <a href="https://httpd.apache.org/docs/2.4/mod/mod_proxy_fcgi.html">mod_proxy_fcgi</a></p>

<p>You need to have <code class="highlighter-rouge">mod_proxy_fcgi</code> installed and loaded. This module is Apacheâ€™s built-in module, so it is very likely that you will have it with your Apache installation. You just need to make sure it is loaded.</p>

<h3 id="debian">Debian</h3>

<p>For example, on Debian,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo a2enmod proxy_fcgi
$ sudo systemctl restart apache2
</code></pre></div></div>

<p>Create virtual host config and add <code class="highlighter-rouge">ProxyPassMatch</code>, for example</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:80&gt;
     ServerName www.example.com
     DocumentRoot /home/example/public

     &lt;Directory "/home/example/public"&gt;
         Options +ExecCGI
         AllowOverride FileInfo
         Require all granted
     &lt;/Directory&gt;

    ProxyRequests Off
    ProxyPassMatch /(css|images|js).* !
    ProxyPassMatch ^/(.*)$ fcgi://127.0.0.1:20477
&lt;/VirtualHost&gt;
</code></pre></div></div>
<p>You may need to replace <code class="highlighter-rouge">fcgi://127.0.0.1:20477</code> with host and port where your
application is running.</p>

<p>Two <code class="highlighter-rouge">ProxyPassMatch</code> lines tell Apache to serve requests for
files inside <code class="highlighter-rouge">css</code>, <code class="highlighter-rouge">images</code>, <code class="highlighter-rouge">js</code> directories directly. For other, pass requests to our application.</p>

<p>On Debian, save it to <code class="highlighter-rouge">/etc/apache2/sites-available</code> for example as <code class="highlighter-rouge">fano-fastcgi.conf</code>
Enable this site and restart Apache</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo a2ensite fano-fastcgi.conf
$ sudo systemctl restart apache2
</code></pre></div></div>

<h4 id="use-unix-domain-socket">Use unix domain socket</h4>

<p>If your Fano application and Apache run on same machine, you can get small improvement by using unix domain socket file. See example <a href="https://github.com/fanoframework/fano-fcgi-unix">Fano Fastcgi Unix application</a>.</p>

<p>If application is listening using socket file <code class="highlighter-rouge">/tmp/fano-fcgi.sock</code>, you need to change <code class="highlighter-rouge">ProxyPassMatch</code> as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ProxyPassMatch ^/(.*)$ "unix:/tmp/fano-fcgi.sock|fcgi://127.0.0.1/"
</code></pre></div></div>
<p>Note that <code class="highlighter-rouge">|fcgi://127.0.0.1/</code> is required so <code class="highlighter-rouge">mod_proxy_fcgi</code> is called to handle request, although, host and port information are ignored.</p>

<h4 id="socket-file-permission-issue">Socket file permission issue</h4>

<p>You need to make sure that <code class="highlighter-rouge">/tmp/fano-fcgi.sock</code> is writeable by Apache.</p>

<p>If you run with something like</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./bin/app.cgi
</code></pre></div></div>
<p><code class="highlighter-rouge">/tmp/fano-fcgi.sock</code> file will be own by user where above command is executed. It will cause permission denied for Apache user.</p>

<p>For development stage, easy solution is just change owner of file. After application is bound and listen, you may want to open another
shell and execute</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo chown [your current user]:www-data /tmp-fano-fcgi.sock
</code></pre></div></div>
<p>where <code class="highlighter-rouge">www-data</code> is user which Apache runs.</p>

<p>Using <code class="highlighter-rouge">/tmp</code> also may cause problem if you run Debian 9 - based distribution (such as Ubuntu 18.04). In Debian 9 (Stretch) or newer, each user, by default, has private /tmp directory. So if you run application as current user, <code class="highlighter-rouge">/tmp/fano-fcgi.sock</code> will not be found by Apache which run as different user.</p>

<p>Proper way is setup application to run as service, set socket file to <code class="highlighter-rouge">/var/run</code> and set group which service run, add Apache user into that group. Then you can
just run application using</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo systemctl start [your-app-service-name]
</code></pre></div></div>

<h3 id="fedora">Fedora</h3>

<p>The difference between Debian and Fedora regarding Apache mostly about default service name (Debian uses <code class="highlighter-rouge">apache2</code> and Fedora uses <code class="highlighter-rouge">httpd</code>), user which Apache run (Debian uses <code class="highlighter-rouge">www-data</code> user while Fedora uses <code class="highlighter-rouge">apache</code>) and default Apache configuration location.</p>

<ul>
  <li>Create virtual host</li>
</ul>

<p>Apache main configuration is stored in <code class="highlighter-rouge">/etc/httpd/httpd.conf</code>. To add virtual host configuration, you can simply add entry to this file or prefered way is to create configuration in file <code class="highlighter-rouge">/etc/httpd/conf.d/</code> directory.</p>

<p>In Fedora and Apache 2.4, <code class="highlighter-rouge">/etc/httpd/conf.d/</code> directory will be search for additional configurations. So you can just create virtual host file inside this directory.</p>

<ul>
  <li>Reload Apache service</li>
</ul>

<p>Tell Apache to load configuration by running</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo systemctl reload httpd
</code></pre></div></div>

<h2 id="apache-with-mod_fcgid-module">Apache with mod_fcgid module</h2>

<p>To deploy as FastCGI application with <a href="https://httpd.apache.org/mod_fcgid/mod/mod_fcgid.html">mod_fcgid</a>, make sure you use <code class="highlighter-rouge">TSimpleSockFastCGIWebApplication</code> as base application.
Internally, it uses <code class="highlighter-rouge">TBoundSocketSvrImpl</code> as socket server.</p>

<p>Unlike <code class="highlighter-rouge">mod_proxy_fcgi</code> module where our application is run independently,
<code class="highlighter-rouge">mod_fcgid</code> provides automatic process management. So our application process lifecycle is managed by this module. It will spawn or kill one or more our application processes based on request load.</p>

<p>Socket connection is already bound and listen by <code class="highlighter-rouge">mod_fcgid</code>. so we need to
use <code class="highlighter-rouge">TBoundSocketSvrImpl</code> as socket server.</p>

<p>and of course you need to have <code class="highlighter-rouge">mod_fcgid</code> installed and loaded.</p>

<h3 id="debian-1">Debian</h3>

<p>To install <code class="highlighter-rouge">mod_fcgid</code>,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo apt-get install libapache2-mod-fcgid
</code></pre></div></div>

<p>To enable it,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo a2enmod fcgid
$ sudo systemctl restart apache2
</code></pre></div></div>

<p>Create virtual host config and add <code class="highlighter-rouge">fcgid-script</code>, for example</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:80&gt;
     ServerName www.example.com
     DocumentRoot /home/example/public

     &lt;Directory "/home/example/public"&gt;
        Options +ExecCGI
        AllowOverride FileInfo
        Require all granted
        AddHandler fcgid-script .cgi
        DirectoryIndex app.cgi
     &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre></div></div>

<p>Configuration above basically tells Apache to give any request to *.cgi file to
be handled by <code class="highlighter-rouge">mod_fcgid</code> module (identified by <code class="highlighter-rouge">fcgid-script</code> handler).</p>

<h2 id="nginx">Nginx</h2>

<h3 id="debian-2">Debian</h3>

<p>Create virtual host configuration in <code class="highlighter-rouge">/etc/nginx/sites-available</code>, for example</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
    listen 80;
    root /home/example/public;
    index index.html;
    server_name example.com;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ \.*$ {
        fastcgi_pass 127.0.0.1:20477;
        include fastcgi_params;
    }

    location ~ /\.ht {
        deny all;
    }
}
</code></pre></div></div>
<p>Change <code class="highlighter-rouge">fastcgi_pass</code> to match host and port where application is listening.</p>

<p>If listening using unix domain socket, you need to change <code class="highlighter-rouge">fastcgi_pass</code> to</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fastcgi_pass unix:/tmp/fano-fcgi.sock;
</code></pre></div></div>

<p>where <code class="highlighter-rouge">/tmp/fano-fcgi.sock</code> is socket file which application using and of course it must be writeable by nginx.</p>

<p><a href="/deployment">Back to Deployment</a></p>

        </div>
    </section>
</div>


    <!-- Scripts -->
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/jquery.scrollex.min.js"></script>
    <script src="/assets/js/jquery.scrolly.min.js"></script>
    <script src="/assets/js/browser.min.js"></script>
    <script src="/assets/js/breakpoints.min.js"></script>
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/main.js"></script>

</body>
</html>

