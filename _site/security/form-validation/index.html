<!DOCTYPE html>
<!--
Hyperspace by HTML5 UP
html5up.net | @ajlkn
Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
<head>
    <title>Form Validation - Fano Framework</title>
    <meta charset="utf-8" />
    <meta name="description" content="Handling form validation in Fano Framework">
    <meta name="keywords" content="fano, web application, framework, pascal, programming, language, free pascal">
    <meta name="robots" content="index, follow"/>
    <meta property="og:title" content="Form Validation"/>
    <meta property="og:site_name" content="Fano Framework"/>
    <meta property="og:url" content="http://localhost:4000/security/form-validation/"/>
    <meta property="og:description" content="Handling form validation in Fano Framework"/>
    <meta property="og:type" content="website"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="shortcut icon" href="/assets/images/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="/assets/css/main.css" />
    <noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript>
</head>
<body class="is-preload">


<!-- Sidebar -->
<section id="sidebar">
    <div class="inner">
        <nav>
            <ul>
                
                    <h3>Getting Started</h3>
                      <ul class="alt">
                        
                          <li><a href="/getting-started">Getting Started</a></li>
                        
                          <li><a href="/tutorials">Step By Step Tutorials</a></li>
                        
                      </ul>
                
                    <h3>Basic</h3>
                      <ul class="alt">
                        
                          <li><a href="/getting-started">Getting Started</a></li>
                        
                      </ul>
                
            </ul>
        </nav>
    </div>
</section>


<!-- Wrapper -->
<div id="wrapper">
    <!-- Main -->
    <section id="main" class="wrapper">
        <div class="inner">
            <h1 class="major">Form Validation</h1>

<p>We should never trust data coming from user input. Fano Framework provides mechanism
for web application developer to validate data.</p>

<h2 id="working-with-irequestvalidator-and-ivalidationrules">Working with IRequestValidator and IValidationRules</h2>

<p><code class="highlighter-rouge">IRequestValidator</code> is interface for any class having capability to validate request and returns validation result.</p>

<p>While <code class="highlighter-rouge">IValidationRules</code> is interface for any class having capability to manage one or more validation rule.</p>

<p>Fano Framework provides <code class="highlighter-rouge">TValidation</code> class which implements both interfaces.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var requestValidator : IRequestValidator;
    validatorRules : IValidationRules;
...
requestValidator := TValidation.create(THashList.create());
validatorRules := requestValidator as IValidationRules;
</code></pre></div></div>

<h2 id="validation-rule">Validation rule</h2>

<p>A validation rule is class which responsible to decide if data being processed is valid or not. Any class implements <code class="highlighter-rouge">IValidator</code> interface can be used as validation rule and it must implements following methods,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function isValid(
    const key : shortstring;
    const dataToValidate : IList;
    const request : IRequest
) : boolean;

function errorMessage(const key : shortstring) : string;
</code></pre></div></div>

<h3 id="isvalid-method">isValid() method</h3>

<p>This method expects following parameters,</p>

<ul>
  <li><code class="highlighter-rouge">key</code>, name of field to be validated,</li>
  <li><code class="highlighter-rouge">dataToValidate</code>, instance which contains query strings or request body parameters,</li>
  <li><code class="highlighter-rouge">request</code>, instance of current request</li>
</ul>

<p>It must return boolean value of <code class="highlighter-rouge">true</code> if validation should pass or <code class="highlighter-rouge">false</code> otherwise.</p>

<h3 id="errormessage-method">errorMessage() method</h3>

<p>This method expects following parameters,</p>

<ul>
  <li><code class="highlighter-rouge">key</code>, name of field to be validated,</li>
</ul>

<p>It must return string of validation error message.</p>

<p>Developer do not call both methods directly. It will be called by <code class="highlighter-rouge">IRequestValidator</code> instance when validating request.</p>

<h2 id="add-validation-rules">Add validation rules</h2>

<p><code class="highlighter-rouge">IValidationRules</code> interface has methods <code class="highlighter-rouge">addRule()</code> which developer can use to add a validation rule and associate it with field. First parameter is field name and second is validation rule.</p>

<p>For example if you have following form,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;form id="frmCreateUser" method="post" action="/create-user"&gt;
    &lt;label for="usernameInput"&gt;Username&lt;/label&gt;
    &lt;input id="usernameInput" name="username" type="text"&gt;
    &lt;label for="emailInput"&gt;Email&lt;/label&gt;
    &lt;input id="emailInput" name="email" type="text"&gt;
&lt;/form&gt;
</code></pre></div></div>

<p>You need that both username and email are mandatory. Username is restricted to alpha numeric and dash character only. Email must conform to email address format.</p>

<p>Following validation rules are examples to satisfy above requirement.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>validationRules
.addRule(
    'username',
    TCompositeValidator.create([
        TRequiredValidator.create(),
        TAlphaNumDashValidator.create(TRegex.create())
    ])
)
.addRule(
    'email',
    TCompositeValidator.create([
        TRequiredValidator.create(),
        TEmailValidator.create(TRegex.create())
    ])
);
</code></pre></div></div>
<p><code class="highlighter-rouge">TCompositeValidator</code> is built-in validation rule implementation which combine one or more validators as one so that complex validation rule can be achieved by combining several simple validation rules.</p>

<h2 id="validate-request">Validate request</h2>

<p>You can either do validation in middleware or in controller. If same validation rules can be applied to several controllers, then validation in middleware is more suitable.</p>

<p>To validate a request, you need to call <code class="highlighter-rouge">validate()</code> method of <code class="highlighter-rouge">IRequestValidator</code> instance and pass current request instance. It returns <code class="highlighter-rouge">TValidationResult</code> record type which is declared as follows</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type
    TValidationMessage = record
        key : shortstring;
        errorMessage : string;
    end;
    TValidationMessages = array of TValidationMessage;

    TValidationResult = record
        isValid : boolean;
        errorMessages : TValidationMessages;
    end;
</code></pre></div></div>

<p>For example, here we validate request inside controller</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function TMyController.handleRequest(
    const request : IRequest;
    const response : IResponse;
    const args : IRouteArgsReader
) : IResponse;
var i, len : integer;
    validationRes : TValidationResult;
begin
    if fValidation.validate(request).isValid then
    begin
        //validation success
        response.body().write('Hey things are OK');
    end else
    begin
        validationRes := fValidation.lastValidationResult();
        response.body().write('Validation fails:');
        response.body().write('&lt;ul&gt;');
        len := length(validationRes.errorMessages);
        for i := 0 to len - 1 do
        begin
            response.body().write(
               '&lt;li&gt;' + validationRes.errorMessages[i].errorMessage + '&lt;/li&gt;'
            );
        end;
        response.body().write('&lt;/ul&gt;');
    end;
    result := response;
end;
</code></pre></div></div>

<p>Please note that <code class="highlighter-rouge">lastValidationResult()</code> return last validation status so, above example can be simplified by removing <code class="highlighter-rouge">lastValidationResult()</code> call as follows</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    validationRes := fValidation.validate(request);
    if validationRes.isValid then
    begin
        //validation success
        response.body().write('Hey things are OK');
    end else
    begin
        response.body().write('Validation fails:');
        response.body().write('&lt;ul&gt;');
        len := length(validationRes.errorMessages);
        ...
    end;
    ...
</code></pre></div></div>

<p><code class="highlighter-rouge">lastValidationResult()</code> method is provided so developer can execute validation in middleware and later in controller inspects last validation status and act accordingly.</p>

<h2 id="built-in-validation-rule">Built-in validation rule</h2>

<p>Fano Framework comes with several built-in validation rules, some are validation rule mentioned in above code example. Read <a href="/security/form-validation/built-in-validation-rules">Built-in Validation Rules</a> for more information.</p>

<h2 id="writing-your-own-validation-rule">Writing your own validation rule</h2>

<p>If built-in validation rules do not meet your requirement, you can create your own validation rule by creating class that implements <code class="highlighter-rouge">IValidator</code>.</p>

<p>To simplify, Fano Framework provides <code class="highlighter-rouge">TBaseValidator</code> class which developer can use to create validation rule. It is abstract class which developer required to implements its protected method <code class="highlighter-rouge">isValidData()</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function isValidData(
    const dataToValidate : string;
    const dataCollection : IReadOnlyList;
    const request : IRequest
) : boolean; virtual; abstract;
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">dataToValidate</code> will contain actual data of current field being validated.</li>
  <li><code class="highlighter-rouge">dataCollection</code> will contain list of key value pair of all query strings and POST body of request.</li>
  <li><code class="highlighter-rouge">request</code> will contain current request object, in case you need to more informations.</li>
</ul>

<p>Your implementation must return <code class="highlighter-rouge">true</code> if validation should pass or <code class="highlighter-rouge">false</code> otherwise.</p>

<p>For example, following code is implementation of custom validation rule which pass validation only if data being validated is registered and active user id.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unit ActiveUserValidatorImpl;

interface

{$MODE OBJFPC}
{$H+}

uses

    fano;

type

    TActiveUserValidator = class(TBaseValidator)
    private
        fDatabase : IRdbms;
    protected
        function isValidData(
            const userId : string;
            const dataCollection : IList;
            const request : IRequest
        ) : boolean; override;
    public
        constructor create(const db : IRdbms);
        destructor destroy(); override
    end;

implementation

resourcestring

    sErrFieldMustBeActiveUserId = 'Field %s must be active user id';

    constructor TActiveUserValidator.create(const db : IRdbms);
    begin
        inherited create(sErrFieldMustBeActiveUserId);
        fDatabase := db;
    end;

    destructor TActiveUserValidator.destroy();
    begin
        fDatabase := nil;
        inherited destroy();
    end;

    function TActiveUserValidator.isValidData(
        const userId : string;
        const dataCollection : IList;
        const request : IRequest
    ) : boolean;
    var sql : string;
    begin
        sql := 'SELECT user_id FROM users '+
            'WHERE user_id = :userId AND status = :userStatus LIMIT 1';
        result := (fDatabase
            .prepare(sql)
            .paramStr('userId', userId)
            .paramStr('userStatus', 'active')
            .execute()
            .resultCount() &gt; 0);
    end;
end.

</code></pre></div></div>

<h2 id="explore-more">Explore more</h2>

<ul>
  <li><a href="/security/form-validation/built-in-validation-rules">Built-in Validation Rules</a></li>
  <li><a href="/working-with-request">Working with request</a></li>
  <li><a href="/middlewares">Middlewares</a></li>
</ul>

<ul class="actions">
    <li><a href="/documentation" class="button">Documentation</a></li>
</ul>

        </div>
    </section>
</div>


    <!-- Scripts -->
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/jquery.scrollex.min.js"></script>
    <script src="/assets/js/jquery.scrolly.min.js"></script>
    <script src="/assets/js/browser.min.js"></script>
    <script src="/assets/js/breakpoints.min.js"></script>
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/main.js"></script>

</body>
</html>

